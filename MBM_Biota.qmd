---
title: "MBM_Biota"
author: "Maddy Enda"
format: html
editor: visual
eval: true
echo: true 
warning: false
message: false
---

### Load packages and preliminary exploration

```{r}
# Load relevant libraries
library(tidyverse)
library(dplyr)
library(terra)
library(tmap)
library(sf)
library(here)
library(stars)
library(janitor)
```

```{r}
# Read in the pre-filtered Biota data set that only has CA observations
biota_data <- readRDS("Biota.rds")
```

```{r}
# Preliminary exploration of biota data
colnames(biota_data)

# Number of observations and columns for our df
dim(biota_data)
```

```{r}
# Load in the MPA boundary data
MPA_boundary <- sf::st_read("data/California_Marine_Protected_Areas_[ds582]")

mpa <- MPA_boundary %>%
   clean_names() %>%
  filter(name == "Point Lobos SMR") %>%
  # Select relevant columns
  select(-c("objectid", "ccr", "area_sq_mi", "study_regi", "fullname", "ccr_int", "shortname","acres", "shape_are", "shape_len")) %>%
  mutate(area_km_mpa = hectares / 100) %>%  # Convert hectares to square km
  select(-hectares)
```

### Join Biota data to MPA data

```{r}
# Check CRS of both data sets
st_crs(biota_data)== st_crs(mpa)

# Match CRS
mpa <- st_transform(mpa, crs = st_crs(biota_data))

# Perform spatial join: Keep MPA columns and match substrate data
mpa_lobos <- st_join(mpa, biota_data, left = TRUE)
```

```{r}
# Convert the shape_area column in km

# Reproject to a UTM Zone (Example: UTM Zone 10N for the U.S. West Coast)
mpa_lobos <- st_transform(mpa_lobos, crs = 32610)  # Change EPSG based on your region

# Calculate the area in square meters
mpa_lobos$Biota_Area_m2 <- st_area(mpa_lobos$Shape_Area)

# Convert to square kilometers
mpa_lobos$Biota_Area_km2 <- mpa_lobos$Biota_Area_m2 / 1e6

# Print first few rows with updated area values
print(head(mpa_lobos[, c("Biota_Area_m2", "Biota_Area_km2")]))
```

```{r}
colnames(mpa_lobos)
```

```{r}
# Find percentage of each biota in the MPA
mpa_lobos <- mpa_lobos %>%
  mutate(pct_biota = (Biota_Area_km2 / area_km_mpa) * 100) %>%  
  # Calculate percentage
    filter(Biota_Area_km2 <= area_km_mpa)
```
